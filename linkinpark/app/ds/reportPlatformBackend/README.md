# ROUTINE REPORT PLATFORM (RRPF)
POC: [Shen Chiang](mailto:shenchiang@jubo.health), [Lucy Chou](mailto:lucychou@jubo.health), [Emma Wang](mailto:emmawang@jubo.health)

This API is the backend of the third generation of Jubo's routine report 
platform. The main feature of this version is make the service an API and 
allow user to generate result manually through user interface on a browser 
or POST request via other services.

## Major Features
- Structure modified to fit openAPI's specification via FastAPI framework.
- Report name was set inside report files, instead of subscription list.
- POC set for each report, and will be presented when error appeared.

## Usage
### Input
- To generate a report, a `POST` request must be sent to the report's URL 
  with **org**, **start**, **end** and **suffix**(optional) as body.<br> 
  (Please refer to the docs generated by FastAPI for the schema of the dody.)
- The report's URL will be named by its function name as subdomain.<br>
  (eg. The function name for generating the 錯誤測試用報告 is `error_report`. 
  Therefore, the subdomain for this report will be `/error_report`)
- All current available reports with its function name in parentheses will 
  be listed in the *Current available reports* section.

### Output
- If the report was generated successfully, then the report file in bytes 
  will be returned.
- Else an HTML document with detailed error message will be given 
  as alternative. 

## Maintenance
### Create New Reports
1. Create a new file in the folder `./reports`.
2. The function name should be exact the same as the file name (without the 
   file suffix *.py*).
3. A docstring must exist at top, which contains the **reportName** and 
   **POC** of that report.
4. The input of the function must include **org**, **start**, **end** and 
   **suffix**.
5. The function must return a **BytesIO** object.
6. Make good use of the customized exceptions in `./utils/exceptions.py` for 
   edge cases to pass the unit test.
7. Try to make the error message meaningful, since if the user knows what went 
   wrong he/she may solve it by themselves.

### Unit Test
  *Unit test for this service was added on 2023-12-06*
* Will use three organizations, one for each type to test.\
  *(residential, day care and home care)*
* Will use five different query period to test.\
  *(1 day, 1 week, 1 month, 1 quarter and 1 year)*
* All reports in the folder `./reports` will be tested.\
  *(All new reports will be add to test automatically)*
* Customize exceptions will pass the unit test event if it was raised.\
  *(Those are already known errors, and this unit test aim to discover unknown
    error.)*
### TODO
- **(Highest priority)** Avoid maintaining two versions, the original 
  distribution on **[Datarch](https://gitlab.smart-aging.tech/ds/infrastructure/datarch/-/tree/master/pipelines/ds_reportplatform_generator)**
  should be modified. In a future version, the pipeline on **Datarch** will 
  only serve as a scheduler and call the API of this distribution.
  (Actual update date still needs to be planed.)<br>
  ***Warning: All developers must be aware not to differentiate the two 
  distribution before this update was done.***
- Add bug reporting features. Now error message with POC of that report will be 
  shown to end user when failed generating a report. The user still needs to 
  copy the message and send it to the POC. By adding a button on the UI to auto 
  report bugs seems to be a good feature to try for enhancing the user 
  experience.